<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cron Admin Panel</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0f172a;
      --secondary: #1e293b;
      --accent: #f59e0b;
      --success: #10b981;
      --danger: #ef4444;
      --text: #f8fafc;
      --text-secondary: #cbd5e1;
      --border: #334155;
      --bg-overlay: rgba(15, 23, 42, 0.95);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'JetBrains Mono', monospace;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: var(--text);
      min-height:100vh;
      position: relative;
      overflow-x: hidden;
    }
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(248,250,252,0.03) 2px, rgba(248,250,252,0.03) 4px),
        repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(248,250,252,0.03) 2px, rgba(248,250,252,0.03) 4px);
      pointer-events: none;
      z-index: 1;
    }
    .container { max-width:1400px; margin:0 auto; padding:2rem; position:relative; z-index:2; }
    .login-screen { display:flex; align-items:center; justify-content:center; min-height:100vh; padding:2rem; }
    .login-box {
      background:var(--bg-overlay);
      border:2px solid var(--border);
      padding:3rem;
      border-radius:4px;
      max-width:450px;
      width:100%;
      backdrop-filter:blur(10px);
      box-shadow:0 25px 50px -12px rgba(0,0,0,0.5);
      animation:slideUp 0.5s ease;
    }
    @keyframes slideUp { from {opacity:0; transform:translateY(30px);} to {opacity:1; transform:translateY(0);} }
    .login-title { font-family:'Playfair Display',serif; font-size:2.5rem; font-weight:900; margin-bottom:0.5rem; color:var(--accent); letter-spacing:-1px; }
    .login-subtitle { color:var(--text-secondary); margin-bottom:2rem; font-size:0.875rem; text-transform:uppercase; letter-spacing:2px; }
    .form-group { margin-bottom:1.5rem; }
    label { display:block; margin-bottom:0.4rem; color:var(--text-secondary); font-size:0.78rem; text-transform:uppercase; letter-spacing:1px; font-weight:600; }
    input[type="email"], input[type="password"], input[type="text"], input[type="date"], input[type="datetime-local"], textarea, select {
      width:100%; padding:0.85rem 1rem;
      background:var(--secondary); border:1px solid var(--border); border-radius:3px;
      color:var(--text); font-family:'JetBrains Mono',monospace; font-size:0.9rem; transition:all 0.2s;
    }
    input:focus, textarea:focus, select:focus { outline:none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(245,158,11,0.12); }
    textarea { min-height:420px; font-size:0.82rem; line-height:1.5; resize:vertical; }
    .btn {
      padding:0.9rem 2.2rem; border:none; border-radius:3px;
      font-family:'JetBrains Mono',monospace; font-weight:600; font-size:0.9rem;
      text-transform:uppercase; letter-spacing:1.1px; cursor:pointer; transition:all 0.3s;
      position:relative; overflow:hidden;
    }
    .btn::before {
      content:''; position:absolute; top:50%; left:50%; width:0; height:0; border-radius:50%;
      background:rgba(255,255,255,0.12); transform:translate(-50%,-50%);
      transition:width 0.7s, height 0.7s;
    }
    .btn:hover::before { width:360px; height:360px; }
    .btn-primary { background:var(--accent); color:var(--primary); width:100%; }
    .btn-primary:hover { background:#d97706; transform:translateY(-1px); }
    .btn-secondary { background:var(--secondary); color:var(--text); border:1px solid var(--border); }
    .btn-danger { background:var(--danger); color:white; }
    .btn-success { background:var(--success); color:white; }
    .dashboard { display:none; }
    .header { display:flex; justify-content:space-between; align-items:center; margin-bottom:3rem; padding-bottom:1.8rem; border-bottom:2px solid var(--border); }
    .header-title { font-family:'Playfair Display',serif; font-size:3.1rem; font-weight:900; color:var(--accent); letter-spacing:-2.2px; }
    .header-info { text-align:right; }
    .user-email { color:var(--text-secondary); font-size:0.9rem; margin-bottom:0.6rem; }
    .tabs { display:flex; gap:1.2rem; margin-bottom:2.2rem; border-bottom:2px solid var(--border); }
    .tab {
      padding:1rem 2.2rem; background:transparent; border:none;
      color:var(--text-secondary); font-weight:600; font-size:0.9rem;
      text-transform:uppercase; letter-spacing:1.2px; cursor:pointer; transition:all 0.3s; position:relative;
    }
    .tab::after { content:''; position:absolute; bottom:-2px; left:0; width:0; height:2.5px; background:var(--accent); transition:width 0.3s; }
    .tab:hover { color:var(--text); }
    .tab.active { color:var(--accent); }
    .tab.active::after { width:100%; }
    .tab-content { display:none; animation:fadeIn 0.5s ease; }
    .tab-content.active { display:block; }
    @keyframes fadeIn { from {opacity:0; transform:translateY(12px);} to {opacity:1; transform:translateY(0);} }
    .card { background:var(--bg-overlay); border:2px solid var(--border); border-radius:4px; padding:2.2rem; margin-bottom:2.2rem; backdrop-filter:blur(10px); }
    .card-title { font-family:'Playfair Display',serif; font-size:1.7rem; font-weight:700; margin-bottom:1.6rem; color:var(--accent); }
    .grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:1.6rem; }
    .alert { padding:1rem 1.6rem; border-radius:3px; margin-bottom:1.6rem; font-size:0.9rem; animation:slideDown 0.3s ease; }
    @keyframes slideDown { from {opacity:0; transform:translateY(-12px);} to {opacity:1; transform:translateY(0);} }
    .alert-success { background:rgba(16,185,129,0.12); border:1px solid var(--success); color:var(--success); }
    .alert-error { background:rgba(239,68,68,0.12); border:1px solid var(--danger); color:var(--danger); }
    .time-preview { font-size:0.82rem; color:#94a3b8; margin-top:0.5rem; line-height:1.4; }
    .time-preview strong { color:var(--accent); }
    .question-hint, .time-hint {
      font-size:0.82rem; color:#94a3b8; margin-top:0.6rem; line-height:1.5;
    }
    .time-hint { font-style:italic; }
    @media (max-width:768px) {
      .header { flex-direction:column; align-items:flex-start; gap:1.2rem; }
      .header-title { font-size:2.4rem; }
      .tabs { overflow-x:auto; }
      .tab { padding:0.9rem 1.6rem; }
      .grid { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>

  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen">
    <div class="login-box">
      <h1 class="login-title">Cron</h1>
      <p class="login-subtitle">Admin Control Panel</p>
      <div id="loginError" class="alert alert-error hidden"></div>
      <form id="loginForm">
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" value="admin@bpsc.com" required autocomplete="email">
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" value="admin123" required autocomplete="current-password">
        </div>
        <button type="submit" class="btn btn-primary">
          <span id="loginBtnText">Access Panel</span>
          <span id="loginLoader" class="loading hidden"></span>
        </button>
      </form>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" class="dashboard">
    <div class="container">
      <div class="header">
        <h1 class="header-title">Control Panel</h1>
        <div class="header-info">
          <p class="user-email" id="userEmail"></p>
          <button class="btn btn-secondary" onclick="logout()">Logout</button>
        </div>
      </div>

      <div class="tabs">
        <button class="tab active" onclick="switchTab('create')">Create Test</button>
        <button class="tab" onclick="switchTab('manage')">Manage Tests</button>
      </div>

      <!-- Create Test Tab -->
      <div id="createTab" class="tab-content active">
        <div class="card">
          <h2 class="card-title">Create New Test</h2>
          <div id="createAlert"></div>

          <form id="createTestForm">
           <div class="grid">
         <div class="form-group">
              <label for="testTitle">Test Title</label>
              <input type="text" id="testTitle" placeholder="e.g. BPSC Prelims Mock ‚Äì 15 Feb" required autofocus>
             </div>

            <div class="form-group">
          <label for="testDate">Test Date (YYYY-MM-DD)</label>
            <input type="date" id="testDate" required>
               <div class="time-hint" style="margin-top:0.6rem; font-size:0.82rem; color:#94a3b8;">
               The test will automatically run full day:<br>
                   <strong>00:00:00 IST ‚Äì 23:59:59 IST</strong> on the selected date
              </div>
           </div>
           </div>

              <div class="form-group">
                <label for="endTime">End Time (IST) ‚Äì optional</label>
                <input type="datetime-local" id="endTime">
                <div class="time-preview">
                  Leave empty ‚Üí test ends at <strong>23:59 IST</strong> on selected date
                </div>
              </div>
            </div>

            <div class="question-count-selector form-group">
              <label for="questionCount">Number of Questions</label>
              <select id="questionCount" required>
                <option value="75" selected>Daily Test (Mon‚ÄìSat) ‚Äî 75 questions</option>
                <option value="100">Sunday GS Paper ‚Äî 100 questions</option>
                <option value="80">Sunday CSAT Paper ‚Äî 80 questions</option>
              </select>
              <div class="question-hint">
                ‚Ä¢ 75 ‚Üí regular daily test (GS only)<br>
                ‚Ä¢ 100 ‚Üí GS paper (Sunday full test ‚Äì phase 1)<br>
                ‚Ä¢ 80 ‚Üí CSAT paper (Sunday full test ‚Äì phase 2)
              </div>
            </div>

            <div class="test-type-selector form-group">
              <label for="testType">Test Type</label>
              <select id="testType" required>
                <option value="" disabled selected>Select access type</option>
                <option value="paid">Paid Test (login required)</option>
                <option value="free">Free Practice Test (public)</option>
              </select>
            </div>

            <div class="form-group">
              <label for="questionsJson">Questions (JSON Array)</label>
              <textarea id="questionsJson" placeholder='[{ "questionNumber":1, "questionStatement":"...", "options":{...}, "correctOption":"option1" }, ...]' required></textarea>
              <div class="code-hint">
                <strong>Format:</strong> array of objects with exactly the number of questions selected above.<br><br>
                <strong>Required fields per question:</strong><br>
                ‚Ä¢ questionNumber (number)<br>
                ‚Ä¢ questionStatement (string)<br>
                ‚Ä¢ options (object with option1‚Äìoption4)<br>
                ‚Ä¢ correctOption ("option1" | "option2" | "option3" | "option4")
              </div>
            </div>

            <button type="submit" class="btn btn-success" id="createBtn">
              <span id="createBtnText">Create Test (75 questions)</span>
              <span id="createLoader" class="loading hidden"></span>
            </button>
          </form>
        </div>
      </div>

      <!-- Manage Tests Tab -->
      <div id="manageTab" class="tab-content">
        <div class="card">
          <h2 class="card-title">Existing Tests</h2>
          <div id="manageAlert"></div>
          <div id="testsList" class="test-list">
            <p style="color:var(--text-secondary); text-align:center;">Loading tests...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const API_URL = 'https://cronadminbackend.vercel.app'; // ‚Üê your actual backend URL
let authToken = null;

// Dynamic button text
function updateCreateButtonText() {
  const count = document.getElementById('questionCount').value;
  const type = document.getElementById('testType').value;
  const typeText = type ? (type === 'paid' ? 'Paid' : 'Free') : '';
  document.getElementById('createBtnText').textContent =
    `Create ${typeText ? typeText + ' ' : ''}Test (${count} questions)`;
}

document.getElementById('questionCount').addEventListener('change', updateCreateButtonText);
document.getElementById('testType').addEventListener('change', updateCreateButtonText);

// Login
document.getElementById('loginForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  // ... (login logic remains the same as your original)
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  const loginBtn = document.getElementById('loginBtnText');
  const loginLoader = document.getElementById('loginLoader');
  const errorDiv = document.getElementById('loginError');

  loginBtn.classList.add('hidden');
  loginLoader.classList.remove('hidden');
  errorDiv.classList.add('hidden');

  try {
    const res = await fetch(`${API_URL}/admin/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    if (!res.ok) throw new Error((await res.json())?.message || `HTTP ${res.status}`);
    const data = await res.json();
    if (data.success && data.token) {
      authToken = data.token;
      sessionStorage.setItem('authToken', authToken);
      sessionStorage.setItem('adminEmail', email);
      showDashboard();
    } else {
      throw new Error(data.message || 'Login failed');
    }
  } catch (err) {
    errorDiv.textContent = err.message;
    errorDiv.classList.remove('hidden');
  } finally {
    loginBtn.classList.remove('hidden');
    loginLoader.classList.add('hidden');
  }
});

// Auto-login + defaults
window.addEventListener('DOMContentLoaded', () => {
  const saved = sessionStorage.getItem('authToken');
  if (saved) {
    authToken = saved;
    showDashboard();
  }

  // Default to **tomorrow** instead of today
  const tomorrow = new Date();
  tomorrow.setDate(tomorrow.getDate() + 1);
  document.getElementById('testDate').valueAsDate = tomorrow;

  updateCreateButtonText();
});

function showDashboard() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('dashboard').style.display = 'block';
  document.getElementById('userEmail').textContent = sessionStorage.getItem('adminEmail') || 'admin@bpsc.com';
  loadTests();
}

function logout() {
  sessionStorage.clear();
  authToken = null;
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('dashboard').style.display = 'none';
  document.getElementById('loginForm').reset();
  document.getElementById('email').value = 'admin@bpsc.com';
  document.getElementById('password').value = 'admin123';
}

function switchTab(tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.querySelector(`.tab[onclick="switchTab('${tab}')"]`).classList.add('active');
  document.getElementById(`${tab}Tab`).classList.add('active');
  if (tab === 'manage') loadTests();
}

// Create test
document.getElementById('createTestForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const alertDiv = document.getElementById('createAlert');
  alertDiv.innerHTML = '';
  const btnText = document.getElementById('createBtnText');
  const loader = document.getElementById('createLoader');
  btnText.classList.add('hidden');
  loader.classList.remove('hidden');

  try {
    const title       = document.getElementById('testTitle').value.trim();
    const date        = document.getElementById('testDate').value;
    const startTime   = document.getElementById('startTime').value;
    const endTime     = document.getElementById('endTime').value;
    const questionCount = parseInt(document.getElementById('questionCount').value);
    const testType    = document.getElementById('testType').value;
    const questionsRaw = document.getElementById('questionsJson').value.trim();

    if (!testType) throw new Error("Please select Paid or Free");

    let phase;
    if      (questionCount === 75)  phase = "daily";
    else if (questionCount === 100) phase = "gs";
    else if (questionCount === 80)  phase = "csat";
    else throw new Error("Invalid question count");

    let questions;
    try {
      questions = JSON.parse(questionsRaw);
    } catch {
      throw new Error("Invalid JSON ‚Äì check syntax");
    }

    if (!Array.isArray(questions) || questions.length !== questionCount) {
      throw new Error(`Must provide exactly ${questionCount} questions`);
    }

    const payload = {
      title,
      date,
      startTime: startTime || undefined,
      endTime:   endTime   || undefined,
      questions,
      testType,
      phase
    };

    const res = await fetch(`${API_URL}/admin/create-test-with-questions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      throw new Error(err.message || `HTTP ${res.status}`);
    }

    const data = await res.json();
    if (!data.success) throw new Error(data.message || "Creation failed");

    alertDiv.innerHTML = `<div class="alert alert-success">Test created successfully ‚Üí ${data.startTimeIST ? new Date(data.startTimeIST).toLocaleString('en-IN') : '00:00 IST'} ‚Äì ${data.endTimeIST ? new Date(data.endTimeIST).toLocaleString('en-IN') : '23:59 IST'}</div>`;

    document.getElementById('createTestForm').reset();
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('testDate').valueAsDate = tomorrow;
    document.getElementById('questionCount').value = "75";
    document.getElementById('testType').value = "";
    updateCreateButtonText();

    setTimeout(() => {
      alertDiv.innerHTML = '';
      switchTab('manage');
    }, 3200);

  } catch (err) {
    alertDiv.innerHTML = `<div class="alert alert-error">${err.message}</div>`;
  } finally {
    btnText.classList.remove('hidden');
    loader.classList.add('hidden');
  }
});

// Load & delete tests (unchanged logic, slightly cleaner template)
async function loadTests() {
  const container = document.getElementById('testsList');
  container.innerHTML = '<p style="text-align:center; color:var(--text-secondary);">Loading...</p>';

  try {
    const res = await fetch(`${API_URL}/admin/tests`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const { success, tests } = await res.json();

    if (!success || !tests?.length) {
      container.innerHTML = '<p style="text-align:center; color:var(--text-secondary);">No tests found</p>';
      return;
    }

    container.innerHTML = tests.map(t => `
      <div class="test-item">
        <div class="test-info">
          <h3>${t.title}</h3>
          <div class="test-meta">
            <span>üìÖ ${t.date}</span>
            <span>üìù ${t.totalQuestions || '?'} q</span>
            <span>üïê ${t.startTimeIST ? new Date(t.startTimeIST).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'}) : '00:00'} ‚Äì ${t.endTimeIST ? new Date(t.endTimeIST).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'}) : '23:59'}</span>
            <span style="color:${t.testType==='paid'?'#f59e0b':'#10b981'}">${t.testType.toUpperCase()}</span>
            <span style="color:#60a5fa">${t.phaseDisplay || '‚Äî'}</span>
          </div>
        </div>
        <button class="btn btn-danger" onclick="deleteTest('${t._id}','${t.title.replace(/'/g,"\\'")}')">Delete</button>
      </div>
    `).join('');
  } catch (err) {
    container.innerHTML = `<p style="color:var(--danger); text-align:center;">Error: ${err.message}</p>`;
  }
}

async function deleteTest(id, title) {
  if (!confirm(`Delete "${title}"?`)) return;
  const alertDiv = document.getElementById('manageAlert');
  try {
    const res = await fetch(`${API_URL}/admin/delete-test/${id}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${authToken}` }
    });
    if (!res.ok) throw new Error((await res.json())?.message || `HTTP ${res.status}`);
    const data = await res.json();
    if (data.success) {
      alertDiv.innerHTML = `<div class="alert alert-success">"${title}" deleted</div>`;
      loadTests();
      setTimeout(() => alertDiv.innerHTML='', 2800);
    }
  } catch (err) {
    alertDiv.innerHTML = `<div class="alert alert-error">${err.message}</div>`;
  }
}
</script>
</body>
</html>
